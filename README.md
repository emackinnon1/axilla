# Axilla

A web-based implementation of [Pixlet](https://github.com/tidbyt/pixlet) which is used to develop [Tidbyt](https://tidbyt.com/) applications.

See it live: [`axilla.netlify.app`](https://axilla.netlify.app)

![AXILLA](https://axilla.netlify.app/?output=image)

## Axilla Query Parameters

_note: all query parameters are optional_

| Parameter | Default  | Description |
|-----------|----------|-------------|
| format    | `webp`   | Image format generated by Pixlet. `webp` or `gif` |
| output    | `html`   | Output type returned by the API. `html`, `image`, or `base64`|
| applet    | _AXILLA_ | URL of a Pixlet applet (which should be a [Starlark](https://github.com/bazelbuild/starlark) `.star` file.). Maximum file size 10MB. |
| fileName  | `undefined` | Name of a built-in applet to render (e.g., `digital_rain`, `starfield`). Looks for the applet in the built-in assets folder. |
| pixelate  | `true`   | Set to `false` to disable pixelation simulation. _Note: This is only used when `output` is `html`._

### Special Parameters

_note: when present, other params are ignored and an applet is not executed_

| Parameter | Default     | Description |
|-----------|-------------|-------------|
| version   | `undefined` | When `true` returns Axilla and Pixlet version information as plain text. |

## Applet Query Parameters

Query parameters can be passed to Pixlet for use within an applet (i.e. `config.get('param')`). These parameters are defined by the applet itself. _Note: Axilla query parameters listed above are reserved and will not be passed to the applet._

## Examples

### All Defaults

[`axilla.netlify.app`](https://axilla.netlify.app)

### Raw GIF Image

[`format=gif&output=image`](https://axilla.netlify.app/?format=gif&output=image)

### Base 64 Image String

[`output=base64`](https://axilla.netlify.app/?output=base64)

### Other Parameters

The default Axilla applet accepts one parameter: `text`. Other applets can define and accept their own query parameters.

[`text=You%20Rock!`](https://axilla.netlify.app/?text=You%20Rock!)

### External Applets

#### Without App Parameters

- [`applet=https://raw.githubusercontent.com/tidbyt/pixlet/main/examples/hello_world.star`](https://axilla.netlify.app/?applet=https://raw.githubusercontent.com/tidbyt/pixlet/main/examples/hello_world.star)
- [`applet=https://raw.githubusercontent.com/tidbyt/pixlet/main/examples/clock.star`](https://axilla.netlify.app/?applet=https://raw.githubusercontent.com/tidbyt/pixlet/main/examples/clock.star)

#### With App Parameters

- [`applet=https://raw.githubusercontent.com/btjones/community/main/apps/flags/flags.star&show_name=true&country_code=us`](https://axilla.netlify.app/?applet=https://raw.githubusercontent.com/btjones/community/main/apps/flags/flags.star&show_name=true&country_code=us)
- [`applet=https://raw.githubusercontent.com/btjones/community/main/apps/randomslackmoji/random_slackmoji.star&query=dance`](https://axilla.netlify.app/?applet=https://raw.githubusercontent.com/btjones/community/main/apps/randomslackmoji/random_slackmoji.star&query=dance)

## Built-in Applet Structure

### Available Built-in Applets

Axilla comes with several built-in applets that can be accessed using the `fileName` parameter. Here are some examples:

- [`fileName=digital_rain`](https://axilla.netlify.app/?fileName=digital_rain)
- [`fileName=starfield`](https://axilla.netlify.app/?fileName=starfield)
- [`fileName=dvdlogo`](https://axilla.netlify.app/?fileName=dvdlogo)
- [`fileName=sunrisesunset`](https://axilla.netlify.app/?fileName=sunrisesunset)
- [`fileName=date_progress`](https://axilla.netlify.app/?fileName=date_progress)
- [`fileName=yearprogress`](https://axilla.netlify.app/?fileName=yearprogress)

### Folder Structure

Built-in applets follow a specific folder structure:

```
functions/axilla/assets/
  applet_name/
    applet_name.star
```

Each applet has its own folder inside the `assets` directory, and the Starlark file name must match the folder name. For example:

```
functions/axilla/assets/
  digital_rain/
    digital_rain.star
  starfield/
    starfield.star
```

When you use `fileName=digital_rain` in the URL, Axilla looks for the file at `functions/axilla/assets/digital_rain/digital_rain.star`.

### Adding Custom Applets

To add your own applet to the built-in collection:

1. Create a new folder in the `functions/axilla/assets/` directory with your applet name
2. Place your `.star` file inside the folder, using the same name as the folder
3. Access your applet using `fileName=your_applet_name`

For example, to add a custom applet called "my_clock":

```
functions/axilla/assets/
  my_clock/
    my_clock.star
```

Then access it with: `/?fileName=my_clock`

## Forking / Netlify Deployment

Axilla is deployed to [Netlify](https://www.netlify.com) and utilizes [Netlify Functions](https://www.netlify.com/products/functions/) (which uses [AWS Lambda](https://aws.amazon.com/lambda/) under the hood). To deploy your own version of Axilla:

1. Fork this repo (click Fork button on the top-right corner of this page)
2. [Link your forked repo to Netlify](https://www.netlify.com/blog/2016/09/29/a-step-by-step-guide-deploying-on-netlify/)
3. Visit https://YOUR-SITE-NAME.netlify.app/

## Local Development

1. [Install Netlify Dev](https://www.netlify.com/products/dev/)
2. [Install Pixlet](https://github.com/tidbyt/pixlet#getting-started)
3. Install Axilla dependencies:

        npm install

4. Launch Axilla locally:

        npm run dev

Note: When running locally, Axilla assumes you have Pixlet installed globally on your system and will use the `pixlet` command to execute. A version of Pixlet is included in this repo but has been built to run on the [Amazon Linux 2](https://aws.amazon.com/amazon-linux-2/) operating system so that it can run when deployed as a Netlify/Lambda function.

### Test

Run unit tests:

    npm run test

Run unit tests and watch for changes:

    npm run test:watch

## Running on Raspberry Pi

This project can run on a Raspberry Pi using the local installation of pixlet or the included binaries.

### Prerequisites

1. Node.js and NPM should be installed on your Raspberry Pi
2. Pixlet binary installed (recommended) - follow instructions at https://github.com/tidbyt/pixlet#getting-started

### Installation

1. Clone this repository:
   ```
   git clone https://github.com/emackinnon1/axilla.git
   cd axilla
   ```

2. Install dependencies:
   ```
   npm install
   ```

3. Run the application:
   ```
   ./start.sh
   ```
   If you are on mac, there is a script to test it out:
   ```
   ./macos-start.sh
   ```
   
   Alternatively, use npm:
   ```
   npm start
   ```

4. To run the application in production:

### Accessing the App

Once running, the app will be available at:
- http://localhost:3000

To make it accessible from other devices on your local network, update the `HOST` value in the `config.js` file to your Raspberry Pi's IP address or set `HOST` to `'0.0.0.0'`.

### Configuration

You can configure the application by editing the `config.js` file:

- `PIXLET_BINARY`: The name of the pixlet binary to use (default: 'pixlet')
- `PIXLET_BINARY_PATH`: Path to the pixlet binary (leave empty to use system PATH)
- `LD_LIBRARY_PATH`: Path to the library files (default: './functions/axilla/lib')
- `PORT`: The port to run the server on (default: 3000)
- `HOST`: The host to bind to (default: 'localhost')

### Using Applets

Access the application and use the following URL parameters:
- `fileName`: Name of a built-in applet (e.g., `http://localhost:3000/?fileName=digital_rain`)
- `applet`: URL to a remote applet (e.g., `http://localhost:3000/?applet=https://example.com/myapplet.star`)
- `format`: Output format, either 'webp' or 'gif'
- `output`: Response type, either 'html', 'image', or 'base64'
- Any other parameters will be passed to the applet as configuration

## Pixlet

This application contains code from, and includes binaries of, [Pixlet](https://github.com/tidbyt/pixlet) which is covered under the [Apache License Version 2.0](PIXLET_LICENSE.txt).

## Recent Changes

### Cross-Platform Compatibility

Recent updates have improved cross-platform compatibility:

- The application now uses `os.tmpdir()` to determine the temporary directory location instead of hardcoding `/tmp/`, which improves compatibility across different operating systems.
- Environment variable handling has been improved with a centralized configuration in `config.js`.
- The `PIXLET_ROOT_DIR` environment variable is now set automatically to ensure pixlet can find required modules.

### Enhanced File Structure for Applets

The applet organization has been improved:

- Each applet now has its own directory under `functions/axilla/assets/`.
- Applet files are named to match their containing directory (e.g., `digital_rain/digital_rain.star`).
- This structure makes it easier to add new applets and manage assets related to each applet.

### Local Development Improvements

- Added debugging tools to help identify issues with the pixlet binary execution.
- Improved error handling and reporting when rendering applets.
- Added support for both global pixlet installations and bundled binaries.
